---
title: "Cardiovascular Disease Analysis"
author: "Muhammad Mubashar Shahzad"
date: "`r Sys.Date()`"
output: html_document
---

# Load Necessary Libraries

```{r setup, message=FALSE, warning=FALSE}
library(tidyverse)
library(caret)
library(pROC)
library(ggplot2)
library(reshape2)

data <- read.csv('cardio_train.csv', sep=';')

# Remove unnecessary columns
data$id <- NULL

# Convert age from days to years
data$age_years <- floor(data$age / 365)
data$age <- NULL

# Remove outliers based on realistic medical ranges
data <- data %>%
  filter(height >= 140 & height <= 200, 
         weight >= 40 & weight <= 150, 
         ap_hi >= 90 & ap_hi <= 200, 
         ap_lo >= 60 & ap_lo <= 140)

# Convert categorical variables to factors
data$gender <- factor(data$gender, levels = c(1, 2), labels = c('Female', 'Male'))
data$cholesterol <- factor(data$cholesterol)
data$gluc <- factor(data$gluc)
data$smoke <- factor(data$smoke)
data$alco <- factor(data$alco)
data$active <- factor(data$active)
data$cardio <- factor(data$cardio, levels = c(0, 1), labels = c("No Disease", "Disease"))

# Exploratory Data Analysis (EDA)

## 1. Distribution of Target Variable (Cardio)
ggplot(data, aes(x = cardio, fill = cardio)) +
  geom_bar() +
  labs(title = "Distribution of Cardiovascular Disease", x = "Cardiovascular Disease", y = "Count") +
  theme_minimal()

## 2. Correlation Heatmap
numeric_data <- select(data, height, weight, ap_hi, ap_lo, age_years)
corr_matrix <- cor(numeric_data)

melted_corr <- melt(corr_matrix)

ggplot(melted_corr, aes(x=Var1, y=Var2, fill=value)) +
  geom_tile() +
  geom_text(aes(label=round(value,2)), size=4) +
  scale_fill_gradient2(low="blue", high="red", mid="white", midpoint=0) +
  labs(title="Feature Correlation Heatmap") +
  theme_minimal()

## 3. Age Distribution by Cardiovascular Disease

ggplot(data, aes(x = cardio, y = age_years, fill = cardio)) +
  geom_boxplot() +
  labs(title = "Age Distribution by Cardiovascular Disease", x = "Cardiovascular Disease", y = "Age (years)") +
  theme_minimal()

## 4. Gender Distribution Across Target Variable

ggplot(data, aes(x = gender, fill = cardio)) +
  geom_bar(position = "dodge") +
  labs(title = "Gender Distribution by Cardiovascular Disease", x = "Gender", y = "Count") +
  theme_minimal()

# Model Training

## Splitting the Dataset

set.seed(42)
trainIndex <- createDataPartition(data$cardio, p = 0.8, list = FALSE)
train_data <- data[trainIndex, ]
test_data <- data[-trainIndex, ]

## Logistic Regression Model

log_model <- glm(cardio ~ ., data = train_data, family = binomial)

## Model Predictions

log_pred <- predict(log_model, newdata = test_data, type = 'response')
log_pred_class <- factor(ifelse(log_pred > 0.5, "Disease", "No Disease"))


# Model Evaluation

## Confusion Matrix for Logistic Regression

conf_matrix <- confusionMatrix(log_pred_class, test_data$cardio)
print(conf_matrix)

## Confusion Matrix Visualization

confusion_df <- as.data.frame(conf_matrix$table)
ggplot(confusion_df, aes(Reference, Prediction, fill=Freq)) +
  geom_tile() +
  geom_text(aes(label=Freq), color="white", size=5) +
  scale_fill_gradient(low="blue", high="red") +
  labs(title="Confusion Matrix: Logistic Regression", x="Actual", y="Predicted") +
  theme_minimal()

## Performance Metrics Calculation

# Extract confusion matrix values
TN <- conf_matrix$table[1,1]
FP <- conf_matrix$table[1,2]
FN <- conf_matrix$table[2,1]
TP <- conf_matrix$table[2,2]

# Calculate metrics
accuracy <- (TP + TN) / (TP + TN + FP + FN)
precision <- TP / (TP + FP)
recall <- TP / (TP + FN)  # Sensitivity
specificity <- TN / (TN + FP)
f1_score <- 2 * ((precision * recall) / (precision + recall))
fpr <- FP / (FP + TN)
fnr <- FN / (FN + TP)

# Create a dataframe for visualization
metrics_df <- data.frame(
  Metric = c("Accuracy", "Precision", "Recall (Sensitivity)", "Specificity", "F1-Score", "FPR", "FNR"),
  Value = c(accuracy, precision, recall, specificity, f1_score, fpr, fnr)
)

# Print computed metrics
print(metrics_df)

# Visualisation of metrics

ggplot(metrics_df, aes(x=Metric, y=Value, fill=Metric)) +
  geom_bar(stat='identity') +
  geom_text(aes(label=round(Value, 3)), vjust=-0.5, size=5) +
  labs(title="Performance Metrics of Logistic Regression", x="Metric", y="Value") +
  theme_minimal()



## ROC Curve for Logistic Regression

roc_curve <- roc(test_data$cardio, log_pred)
plot(roc_curve, col="blue", main="ROC Curve - Logistic Regression")
print(auc(roc_curve))

# Feature Importance

importance_lr <- as.data.frame(summary(log_model)$coefficients)
importance_lr$Feature <- rownames(importance_lr)

# Remove intercept for better visualization
importance_lr <- importance_lr[importance_lr$Feature != "(Intercept)", ]

# Rename columns for clarity
colnames(importance_lr) <- c("Estimate", "StdError", "ZValue", "PValue", "Feature")

# Plot feature importance
ggplot(importance_lr, aes(x=reorder(Feature, abs(Estimate)), y=abs(Estimate))) +
  geom_bar(stat='identity', fill='steelblue') +
  coord_flip() +
  labs(title="Feature Importance - Logistic Regression",
       x="Feature", y="Importance (Coefficient Absolute Value)") +
  theme_minimal()


# Visualizations

ggsave("confusion_matrix_logistic.png", width=8, height=6)
ggsave("roc_curve_logistic.png", width=8, height=6)
ggsave("feature_importance_logistic.png", width=8, height=6)










